
name: Deploy Todo

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
    
    - name: Build application
      run: |
        npm run build
    

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    
    - name: Setup VPS Environment
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: sudo apt-get update && which node || (curl -fsSL https://deb.nodesource.com/setup_24.x | sudo -E bash - && sudo apt-get install -y nodejs) && which pm2 || sudo npm install -g pm2
    - name: Copy files to VPS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        source: build/*
        target: /var/www/webapp
        strip_components: 1
    - name: Deploy Application
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: mkdir -p /var/www/webapp && echo 'Files will be copied via SCP action' && cd /var/www/webapp && npm ci --production && which pm2 || sudo npm install -g pm2 && pm2 delete webapp || true && cd /var/www/webapp && pm2 start ecosystem.config.js --name webapp && pm2 save && sudo pm2 startup systemd -u $USER --hp $HOME || true
    - name: Post-deployment Tasks
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: sleep 10 && curl -f http://localhost:3000/health || curl -f http://localhost:3000/ || echo 'Health check failed' && sudo touch /var/log/webapp.log && sudo chown www-data:www-data /var/log/webapp.log
